<div class="container mt-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="display-5 fw-bold">üõí Mon Panier</h1>
        <a routerLink="/products" class="btn btn-outline-primary">
          ‚Üê Retour au catalogue
        </a>
      </div>
    </div>
  </div>

  <!-- Panier vide -->
  <div *ngIf="(itemCount$ | async) === 0" class="text-center py-5">
    <div class="card shadow-sm">
      <div class="card-body py-5">
        <h3 class="text-muted">Votre panier est vide</h3>
        <p class="text-muted">Ajoutez des produits depuis le catalogue !</p>
        <a routerLink="/products" class="btn btn-primary btn-lg mt-3">
          üõçÔ∏è D√©couvrir les produits
        </a>
      </div>
    </div>
  </div>

  <!-- Panier avec articles -->
  <div *ngIf="(itemCount$ | async)! > 0" class="row">
    <!-- Liste des articles -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Articles ({{ itemCount$ | async }})</h5>
          <button class="btn btn-outline-danger btn-sm" (click)="clearCart()">
            üóëÔ∏è Vider le panier
          </button>
        </div>

        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            <div *ngFor="let item of cartItems$ | async" class="list-group-item">
              <div class="row align-items-center">
                <!-- Image -->
                <div class="col-2">
                  <img [src]="item.image" [alt]="item.name" class="img-fluid rounded" style="height: 60px; object-fit: cover;">
                </div>

                <!-- Nom et Prix -->
                <div class="col-4">
                  <h6 class="mb-1">{{ item.name }}</h6>
                  <small class="text-muted">{{ item.price }} ‚Ç¨ / unit√©</small>
                </div>

                <!-- Quantit√© -->
                <div class="col-3">
                  <div class="d-flex align-items-center">
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      (click)="decrementQuantity(item)"
                      [disabled]="item.quantity <= 1">
                      -
                    </button>

                    <span class="mx-3 fw-bold">{{ item.quantity }}</span>

                    <button
                      class="btn btn-outline-secondary btn-sm"
                      (click)="incrementQuantity(item)">
                      +
                    </button>
                  </div>
                </div>

                <!-- Sous-total -->
                <div class="col-2 text-center">
                  <strong class="text-primary">{{ item.price * item.quantity }} ‚Ç¨</strong>
                </div>

                <!-- Supprimer -->
                <div class="col-1 text-end">
                  <button
                    class="btn btn-outline-danger btn-sm"
                    (click)="removeItem(item.productId)">
                    √ó
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- R√©sum√© du panier -->
    <div class="col-lg-4 mt-4 mt-lg-0">
      <div class="card shadow-sm sticky-top" style="top: 20px;">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">üìã R√©sum√©</h5>
        </div>

        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <span>Sous-total:</span>
            <span>{{ total$ | async }} ‚Ç¨</span>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span>Frais de livraison:</span>
            <span class="text-success">Gratuits</span>
          </div>

          <hr>

          <div class="d-flex justify-content-between mb-3">
            <strong>Total:</strong>
            <strong class="h5 text-primary">{{ total$ | async }} ‚Ç¨</strong>
          </div>

          <!-- üî• STATUT SYNCHRONISATION -->
          <div *ngIf="syncState$ | async as state"
               class="alert"
               [ngClass]="{
                 'alert-info': state.status === 'syncing',
                 'alert-success': state.status === 'success',
                 'alert-danger': state.status === 'error',
                 'alert-secondary': state.status === 'idle'
               }">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <strong>{{ state.message }}</strong>
                <div *ngIf="state.lastSync" class="small">
                  Derni√®re synchro: {{ state.lastSync | date:'short' }}
                </div>
              </div>
              <button *ngIf="state.status === 'error'"
                      class="btn-close"
                      (click)="resetSyncState()"></button>
            </div>

            <!-- Spinner pendant la synchro -->
            <div *ngIf="state.status === 'syncing'" class="mt-2">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Chargement...</span>
              </div>
              <small class="ms-2">Ne pas fermer la page...</small>
            </div>
          </div>

          <!-- Boutons d'action -->
          <div class="d-grid gap-2">
            <button class="btn btn-success btn-lg" [disabled]="(itemCount$ | async) === 0">
              üí≥ Commander maintenant
            </button>

            <!-- üî• BOUTON SYNCHRONISATION -->
            <button
              class="btn"
              [ngClass]="{
                'btn-primary': (syncState$ | async)?.status !== 'syncing',
                'btn-outline-primary': (syncState$ | async)?.status === 'syncing'
              }"
              (click)="syncCart()"
              [disabled]="(syncState$ | async)?.status === 'syncing' || (itemCount$ | async) === 0">

              <span *ngIf="(syncState$ | async)?.status === 'syncing'">
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                Synchronisation...
              </span>

              <span *ngIf="(syncState$ | async)?.status !== 'syncing'">
                üîÑ Synchroniser
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
