<div class="container py-4">

  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="fw-bold">ğŸ›’ Mon Panier</h1>
        <a routerLink="/products" class="btn btn-outline-primary btn-sm px-3">
          â† Retour au catalogue
        </a>
      </div>
      <hr class="mt-3">
    </div>
  </div>

  <!-- Panier vide -->
  <div *ngIf="(itemCount$ | async) === 0" class="text-center py-5">
    <div class="card border-0 shadow-sm p-4">
      <div class="card-body">
        <h3 class="text-muted">Votre panier est vide</h3>
        <p class="text-muted">Ajoutez des produits depuis le catalogue !</p>
        <a routerLink="/products" class="btn btn-primary btn-lg mt-3 px-4">
          ğŸ›ï¸ DÃ©couvrir les produits
        </a>
      </div>
    </div>
  </div>

  <!-- Panier rempli -->
  <div *ngIf="(itemCount$ | async)! > 0" class="row g-4">

    <!-- Liste des articles -->
    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 d-flex justify-content-between">
          <h5 class="mb-0 fw-semibold">Articles ({{ itemCount$ | async }})</h5>
          <button class="btn btn-outline-danger btn-sm" (click)="clearCart()">
            ğŸ—‘ï¸ Vider
          </button>
        </div>

        <div class="list-group list-group-flush">

          <div *ngFor="let item of cartItems$ | async"
               class="list-group-item py-3">

            <div class="row align-items-center">

              <!-- Image -->
              <div class="col-2">
                <img [src]="item.image" [alt]="item.name"
                     class="img-fluid rounded"
                     style="height:65px; object-fit:cover;">
              </div>

              <!-- Nom -->
              <div class="col-4">
                <h6 class="fw-semibold mb-1">{{ item.name }}</h6>
                <small class="text-muted">{{ item.price }} FG / unitÃ©</small>
              </div>

              <!-- QuantitÃ© -->
              <div class="col-3">
                <div class="d-flex align-items-center">
                  <button class="btn btn-outline-secondary btn-sm"
                          (click)="decrementQuantity(item)"
                          [disabled]="item.quantity <= 1">
                    -
                  </button>

                  <span class="mx-3 fw-bold">{{ item.quantity }}</span>

                  <button class="btn btn-outline-secondary btn-sm"
                          (click)="incrementQuantity(item)">
                    +
                  </button>
                </div>
              </div>

              <!-- Sous-total -->
              <div class="col-2 text-end">
                <strong class="text-primary">{{ item.price * item.quantity }} FG</strong>
              </div>

              <!-- Supprimer -->
              <div class="col-1 text-end">
                <button class="btn btn-sm btn-light border"
                        (click)="removeItem(item.productId)">
                  âœ•
                </button>
              </div>

            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- RÃ©sumÃ© du panier -->
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 sticky-top" style="top:20px;">
        <div class="card-header bg-primary text-white py-3">
          <h5 class="mb-0 fw-semibold">ğŸ“‹ RÃ©sumÃ©</h5>
        </div>

        <div class="card-body">

          <div class="d-flex justify-content-between mb-2">
            <span>Sous-total:</span>
            <span class="fw-semibold">{{ total$ | async }} FG</span>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span>Frais de livraison:</span>
            <span class="text-success fw-semibold">Gratuits</span>
          </div>

          <hr>

          <div class="d-flex justify-content-between mb-3">
            <strong>Total:</strong>
            <strong class="h5 text-primary">{{ total$ | async }} FG</strong>
          </div>

          <!-- Statut de synchro -->
          <div *ngIf="syncState$ | async as state"
               class="alert py-2"
               [ngClass]="{
                 'alert-info': state.status === 'syncing',
                 'alert-success': state.status === 'success',
                 'alert-danger': state.status === 'error',
                 'alert-secondary': state.status === 'idle'
               }">

            <div class="d-flex justify-content-between">
              <div>
                <strong>{{ state.message }}</strong><br>
                <small *ngIf="state.lastSync">DerniÃ¨re synchro : {{ state.lastSync | date:'short' }}</small>
              </div>

              <button *ngIf="state.status === 'error'"
                      class="btn-close"
                      (click)="resetSyncState()"></button>
            </div>

            <div *ngIf="state.status === 'syncing'" class="mt-2">
              <div class="spinner-border spinner-border-sm"></div>
              <small class="ms-2">Ne pas fermer la page...</small>
            </div>
          </div>

          <!-- Boutons -->
          <div class="d-grid gap-2 mt-3">
            <button class="btn btn-success btn-lg"
                    [disabled]="(itemCount$ | async) === 0">
              ğŸ’³ Commander maintenant
            </button>

            <button class="btn"
                    [ngClass]="{
                      'btn-primary': (syncState$ | async)?.status !== 'syncing',
                      'btn-outline-primary': (syncState$ | async)?.status === 'syncing'
                    }"
                    (click)="syncCart()"
                    [disabled]="(syncState$ | async)?.status === 'syncing' || (itemCount$ | async) === 0">

              <span *ngIf="(syncState$ | async)?.status === 'syncing'">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Synchronisation...
              </span>

              <span *ngIf="(syncState$ | async)?.status !== 'syncing'">
                ğŸ”„ Synchroniser
              </span>

            </button>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>
